# 游戏本地化编辑工具 - 设计文档

## 项目概述

基于 CSV 文件的游戏本地化编辑工具，专注于高效管理和编辑游戏本地化内容，支持大规模数据处理（50000+ 条目）。

---

## 技术栈

- **框架**: Electron
- **前端**: React
- **支持平台**: Windows, macOS

---

## 核心功能需求

### 1. 编码处理
- 自动检测打开的 CSV 文件编码格式
- 保存时使用原编码格式
- 符合 RFC 4180 标准

### 2. 文件监控
- 监控外部文件变更
- 处理文件更新、合并
- 冲突解决机制

### 3. 性能要求
- 高效处理 50000+ 条目
- 流畅的表格编辑体验
- 虚拟滚动优化

### 4. 操作历史
- 所有 CSV 内容操作支持 Undo/Redo
- 完整的编辑历史栈

### 5. 快捷键
- 打开项目: `Ctrl/Cmd + O` (原生菜单)
- 保存所有文件: `Ctrl/Cmd + S` (原生菜单)
- 撤销: `Ctrl/Cmd + Z`
- 重做: `Ctrl/Cmd + Shift + Z` 或 `Ctrl/Cmd + Y`
- 查找: `Ctrl/Cmd + F`
- 替换: `Ctrl/Cmd + H`

### 6. 原生应用菜单

系统提供标准的原生应用菜单，符合各平台的用户习惯：

#### File 菜单
- **Open Project... (Ctrl/Cmd+O)**: 打开项目文件夹
- **Save All (Ctrl/Cmd+S)**: 保存所有未保存的文件
- **Quit**: 退出应用

#### Edit 菜单
- Undo, Redo, Cut, Copy, Paste, Delete, Select All

#### View 菜单
- Reload, Force Reload, Toggle DevTools
- Reset Zoom, Zoom In, Zoom Out
- Toggle Fullscreen

---

## 界面设计

### 整体布局

三列布局结构（从左到右）：

```
┌─────────────┬──────────────────────────┬─────────────────┐
│  文件列表   │      编辑区域            │   功能面板      │
│  (第一列)   │      (第二列)            │   (第三列)      │
└─────────────┴──────────────────────────┴─────────────────┘
```

---

## 第一列：项目文件列表

### 功能描述

#### 1. 文件列表显示
- 显示当前项目中的所有 CSV 文件
- 文件名清晰展示

#### 2. 打开项目
- **通过原生菜单打开**: File → Open Project (Ctrl/Cmd+O)
- 选择文件夹后自动扫描并显示 CSV 文件列表
- 空状态提示："请通过 File → Open Project 打开项目"

#### 3. 文件状态标识
- 未保存的文件名后显示 `*` 标记
- 示例: `dialog.csv*`

#### 4. 右键菜单
- 右键点击文件弹出菜单
- **忽略文件**选项：
  - 选中后该文件不参与全局搜索
  - 不参与 Key 值有效性检查
  - 不参与其他全局操作
- 被忽略的文件需要有视觉标识（如灰色显示或特殊图标）

#### 5. 还原忽略文件
- 提供界面入口查看已忽略的文件列表
- 可以将忽略的文件还原回活动状态

---

## 第二列：编辑区域

### 主编辑区（表格）

#### 布局结构
- **左侧行号栏 (Row Headers)**: 
  - 固定在左侧，显示 1-based 行号。
  - **交互**:
    - **单击**: 选中整行。
    - **拖拽**: 选中多行。
    - **右键**: 弹出行操作菜单 (Insert/Delete Rows)。
  - **视觉**: 灰色背景，与内容区区分。
- **顶部列头栏 (Column Headers)**: 固定在顶部。
- **内容网格**: 主数据区域。

#### Excel 式表格编辑功能

##### 选中与编辑模式

**单击选中 (Selection Mode)**:
- 单击单元格 → 单元格被选中（显示边框高亮）
- 此时**不能直接输入**，只是选中状态

**进入编辑模式的 4 种方式**:

1. **双击 (Double Click)**
   - 双击单元格 → 直接进入编辑模式
   - 在单元格位置显示内联输入框
   - 光标出现在内容末尾

2. **直接输入 (Direct Input)**
   - 选中单元格后，直接按键盘任意键（字母/数字）
   - 自动进入编辑模式，原内容被**替换**
   - 示例：选中 "Hello"，按 "A" → 内容变为 "A"

3. **F2 键编辑 (F2 Edit)**
   - 选中单元格后，按 **F2**
   - 进入编辑模式，原内容**保留**
   - 光标移到内容末尾，可追加或修改

4. **编辑栏输入 (Editor Bar)**
   - 选中单元格后，点击底部的富文本编辑器
   - 立即进入编辑模式，单元格实时同步显示输入内容（但不显示内联输入框）
   - 支持 Tab 键缩进、Alt+Enter 保存并跳转

##### 编辑模式中的操作
- **方向键 ← →**: 移动光标位置（不退出编辑）
- **Home / End**: 跳到内容开头/结尾
- **Backspace / Delete**: 删除字符
- **鼠标点击**: 在内容中定位光标

##### 退出编辑模式
- **Enter** (在内联编辑时): 确认编辑，跳到下一行
- **Alt+Enter** (在编辑栏时): 确认编辑，跳到下一行
- **Tab**: 确认编辑，跳到右侧单元格（仅限内联编辑，编辑栏中为输入 Tab）
- **Esc**: 取消编辑，恢复原内容
- **点击其他单元格**: 确认编辑，选中新单元格

---

### 富文本编辑区（底部）

#### 功能描述
- 位于表格编辑区下方
- **只读预览**：选中任意单元格时，显示其内容（只读）。
- **实时同步**：
  - 在编辑栏输入时，单元格仅做内容同步显示，不进入内联编辑状态，无视觉干扰。
  - 在单元格内联编辑时，编辑栏同步显示内容。
- **状态重置**：切换文件或点击空白处，编辑栏自动保存并更新状态。

#### Unity TextMeshPro 富文本支持
- 支持 TMP 富文本标签的编辑和预览
- **编辑预览模式**: 类似 Typora 的实时渲染
  - 编辑时显示富文本标签
  - 预览时渲染最终效果

#### 支持的标签示例
```
<color=#FF0000>红色文本</color>
<size=20>大字号</size>
<b>粗体</b>
<i>斜体</i>
等等...
```

---

### 技术实现方案：CodeMirror 6

#### 选择理由

使用 **CodeMirror 6** 实现类似 Typora 的富文本编辑体验：
- **光标在标签内**：显示原始 TMP 标签源码（如 `<color=#FF0000>文本</color>`）
- **光标离开**：隐藏标签，只显示样式化的内容（如 <span style="color: red">文本</span>）

#### 核心优势

1. **原生支持焦点切换渲染**
   - 内置装饰器（Decoration）系统可根据光标位置动态显示/隐藏内容
   - Markdown 编辑器（如 Obsidian）都使用此方案

2. **性能卓越**
   - 虚拟渲染，高效处理大文本
   - 增量更新，只重绘变化部分

3. **精确控制**
   - 字符级别的渲染控制
   - 支持嵌套标签解析

#### 实现关键点

##### 1. 装饰器插件
```javascript
import { EditorView, Decoration, ViewPlugin } from '@codemirror/view';

const tmpDecorations = ViewPlugin.fromClass(class {
  constructor(view) {
    this.decorations = this.buildDecorations(view);
  }
  
  buildDecorations(view) {
    const cursorPos = view.state.selection.main.head;
    
    // 遍历所有 TMP 标签
    // 如果光标在标签内：显示源码 + 语法高亮
    // 如果光标不在：隐藏标签，应用样式
  }
});
```

##### 2. TMP 标签解析
支持解析以下标签类型：
- `<color=#RRGGBB>` - 颜色
- `<size=数字>` - 字号
- `<b>` - 粗体
- `<i>` - 斜体
- 支持嵌套（如 `<color=#FF0000>红色<b>加粗</b></color>`）

##### 3. 额外功能
- **自动补全**：输入 `<col` 自动提示 `<color=>`
- **语法验证**：实时检查标签闭合，错误标记红色波浪线
- **快捷键**：`Ctrl+B` 包裹粗体，`Ctrl+K` 插入颜色选择器
- **主题支持**：亮色/暗色模式切换

#### 依赖项
```bash
npm install @codemirror/state @codemirror/view @codemirror/language
```

---

## 第三列：功能面板

### Tab 导航

顶部三个 Tab 按钮：
1. **查找与替换**
2. **Key 值有效性检查**
3. **（预留扩展）**

切换 Tab 时，下方面板内容随之切换。

---

### Tab 1: 查找与替换

#### 界面元素
- **搜索框**: 输入搜索关键词
- **替换 Toggle**: 勾选后显示替换框
- **替换框**: 输入替换内容
- **正则表达式 Toggle**: 勾选后启用正则表达式模式
- **范围选择**: 全局搜索 / 单文件搜索
- **操作按钮**:
  - 查找下一个
  - 替换
  - 全部替换

#### 功能详情

##### 1. 搜索模式
- **全局搜索**: 在所有活动文件中搜索
- **单文件搜索**: 仅在当前打开的文件中搜索

##### 2. 正则表达式
- 勾选后支持正则表达式搜索
- 语法规则与 VSCode 文件搜索一致
- 示例: `^DIALOG_.*`, `\d{3,5}`

##### 3. 替换操作
- **单个替换**: 逐个确认并替换
- **全部替换**: 一次性替换所有匹配项
- 支持正则表达式捕获组替换（如 `$1`, `$2`）

##### 4. 搜索结果列表
- 以列表形式展示所有搜索结果
- 每个结果项包含：
  - **Key 值**
  - **上下文**: 搜索关键词附近的文本片段
  - **文件名**（如果是全局搜索）
  - **行号**

##### 5. 结果跳转
- 点击结果列表中的某一项
- 自动切换到对应文件
- 在表格中跳转到对应行
- 聚焦到对应单元格

---

### Tab 2: Key 值有效性检查

#### 功能描述

##### 1. Key 值定义
- Key 值为 CSV 的**第一列**
- 表头（第一行）可以为任意名称

##### 2. 有效性规则
**有效的 Key 值**仅包含：
- 大写字母 `A-Z`
- 数字 `0-9`
- 下划线 `_`

**示例**:
- ✅ `DIALOG_001`
- ✅ `ITEM_SWORD_2`
- ✅ `UI_BUTTON_CANCEL`
- ❌ `dialog-001` (含小写字母和连字符)
- ❌ `Item.Sword` (含小写字母和点)

##### 3. 全局唯一性
- Key 值在整个项目的所有活动文件中必须唯一
- 跨文件检测重复

##### 4. 非法 Key 列表
- 面板中以列表形式展示所有非法的 Key
- 每个列表项包含：
  - 非法的 Key 值
  - 所在文件名
  - 行号
  - 非法原因（格式不合法 / 重复）

##### 5. 跳转功能
- 点击列表中的非法 Key 项
- 自动跳转到对应文件和位置
- 聚焦到该 Key 所在的单元格

##### 6. Tab 角标
- 当存在非法 Key 时
- Tab 按钮右上角显示红色角标
- 角标数字为非法 Key 的数量
- 示例: `Key 值检查 (⚠️ 5)`

---

## 数据处理规范

### CSV 格式
- 严格遵循 **RFC 4180** 标准
- 正确处理引号、换行符、逗号等特殊字符

### 编码处理
- 启动时自动检测文件编码（UTF-8, GBK, UTF-16 等）
- 保存时保持原编码格式
- 避免编码混乱导致的乱码问题

### 外部文件变更
- 实时监控文件系统变化
- 检测到外部修改时提示用户
- 提供以下选项：
  - **重新加载**: 丢弃本地未保存修改，加载外部版本
  - **保留本地**: 保留本地修改，忽略外部变更
  - **合并**: 尝试自动合并（如无冲突）
  - **手动解决**: 显示冲突内容，手动选择保留哪个版本

---

## 性能优化

### 大数据处理
- 目标：流畅处理 **50000+ 条目**
- 使用虚拟滚动技术（如 `react-window` 或 `react-virtualized`）
- 仅渲染可见区域的行，提升性能

### 编辑响应
- 编辑操作即时响应
- 避免阻塞 UI 线程
- 异步处理大批量操作

### 内存管理
- 避免一次性加载所有数据到内存
- 使用流式处理或分页加载

---

## 扩展性设计

### 预留功能
1. **多语言值合法性检查**（第二列）
   - 检查翻译内容是否符合特定规则
   - 例如：检查占位符数量是否一致
   
2. **第三列扩展 Tab**
   - UI 框架支持动态添加 Tab
   - 预留插件化扩展接口

3. **导出功能**
   - 导出为其他格式（JSON, XML 等）

4. **版本控制集成**
   - Git 集成，显示文件变更状态

---

## 用户体验

### 视觉反馈
- 未保存文件明确标识（`*`）
- 非法数据用颜色高亮（红色）
- 被忽略文件灰色显示
- 搜索结果关键词高亮

### 操作流畅性
- 键盘快捷键完整支持
- 鼠标操作符合直觉
- 拖拽填充响应迅速

### 错误处理
- 友好的错误提示
- 清晰的冲突解决引导
- 操作可撤销（Undo/Redo）

---

## 总结

本工具旨在为游戏本地化工作提供**高效、稳定、易用**的编辑环境，核心特性包括：

- ✅ Excel 式强大表格编辑
- ✅ Unity TMP 富文本支持
- ✅ 全局查找替换与正则表达式
- ✅ 严格的 Key 值有效性检查
- ✅ 大规模数据处理能力
- ✅ 完整的 Undo/Redo 支持
- ✅ 跨平台兼容（Windows, macOS）
